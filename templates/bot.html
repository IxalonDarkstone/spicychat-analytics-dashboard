<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ bot.name }} - Bot Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body style="background-color: #1e1e1e; color: #e0e0e0; margin: 0; padding: 0;">
    <div class="container" style="background-color: #2a2a2a; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">
        <header class="header">
            <h1>{{ bot.name }} Details</h1>
            <a href="{{ bot.link }}" target="_blank" class="action-button">Visit Bot Page</a>
            <a href="{{ url_for('index') }}" class="action-button">Back to Dashboard</a>
        </header>
        {% if bot %}
        <div class="chart-container">
            <img src="{{ url_for('static', filename='charts/bot_' + bot.bot_id + '_total.png') }}" alt="{{ bot.name }} Total Messages Chart" class="chart">
            <img src="{{ url_for('static', filename='charts/bot_' + bot.bot_id + '_delta.png') }}" alt="{{ bot.name }} Daily Changes Chart" class="chart">
        </div>
        <div class="bot-content" style="display: flex; gap: 20px; margin-top: 20px;">
            <div class="avatar-column">
                <img src="{{ bot.avatar_url }}" alt="{{ bot.name }} Avatar" class="large-avatar" onerror="this.src='{{ AVATAR_BASE_URL }}/default-avatar.png'; console.log('Failed to load avatar, using default: ' + this.src);">
            </div>
            <div class="history-chart-container">
                <div class="bot-detail">
                    <h2>{{ bot.title }}</h2>
                    <p>Total Messages: {{ bot.total_fmt }}</p>
                    <p>Delta: {{ bot.delta_fmt }}</p>
                    <h3>Message History</h3>
                    <table class="totals-table" id="historyTable">
                        <thead>
                            <tr>
                                <th data-sort="date" onclick="sortTable(this)">Date</th>
                                <th data-sort="total" onclick="sortTable(this)">Total Messages</th>
                                <th data-sort="daily" onclick="sortTable(this)">Daily Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in history %}
                            <tr>
                                <td>{{ entry.date }}</td>
                                <td>{{ entry.total_fmt }}</td>
                                <td>{{ entry.daily_fmt }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <p>Bot not found.</p>
        {% endif %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const totalsTable = document.getElementById('totalsTable');
            if (totalsTable) {
                const isTotalsCollapsed = sessionStorage.getItem('totalsCollapsed') === 'true';
                totalsTable.style.display = isTotalsCollapsed ? 'none' : 'table';
            }
    
            let sortDirection = {};
            function sortTable(th) {
                const table = document.getElementById('historyTable');
                const tbody = table.getElementsByTagName('tbody')[0];
                const rows = Array.from(tbody.getElementsByTagName('tr'));
                const index = th.cellIndex;
                const sortKey = th.getAttribute('data-sort');
                const isNumeric = sortKey === 'total' || sortKey === 'daily';
    
                // Toggle sort direction
                sortDirection[sortKey] = !sortDirection[sortKey];
                const direction = sortDirection[sortKey] ? 1 : -1;
    
                rows.sort((a, b) => {
                    let aValue = a.cells[index].textContent;
                    let bValue = b.cells[index].textContent;
                    if (isNumeric) {
                        aValue = parseInt(aValue.replace(/[^0-9.-]+/g, '')) || 0;
                        bValue = parseInt(bValue.replace(/[^0-9.-]+/g, '')) || 0;
                    } else {
                        aValue = new Date(aValue);
                        bValue = new Date(bValue);
                    }
                    return direction * (aValue < bValue ? -1 : aValue > bValue ? 1 : 0);
                });
    
                // Re-append sorted rows
                while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
                rows.forEach(row => tbody.appendChild(row));
    
                // Update all th elements to remove sorting indicators, then set the clicked one
                const headers = table.getElementsByTagName('th');
                for (let header of headers) {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                }
                th.classList.add(sortDirection[sortKey] ? 'sorted-asc' : 'sorted-desc');
            }
        });
    </script>
    <style>
        .totals-table th {
            cursor: pointer;
            background-color: #3c6e9f;
        }
        .totals-table th:hover {
            background-color: #355e8a;
        }
        .totals-table th.sorted-asc::after {
            content: " ↑";
        }
        .totals-table th.sorted-desc::after {
            content: " ↓";
        }
    </style>
</body>
</html>