<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Author Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* =========================================================
       Page layout
       ========================================================= */
    .author-layout{
      display:grid;
      grid-template-columns: 320px minmax(720px, 1fr) 360px; /* center guaranteed room */
      gap:18px;
      align-items:start;
    }

    /* Let Authors page use more width than the global 1200px container cap */
    body.authors-page .container{
      max-width: 1900px;     /* adjust if you want even wider */
      width: calc(100% - 64px);
    }
    
    .author-sidebar,
    .tags-sidebar{
      position:sticky;
      top:110px;
      background:var(--card-color);
      border:1px solid var(--border-color);
      border-radius:12px;
      box-shadow:0 2px 6px var(--shadow-2);
      padding:14px;
      max-height: calc(100vh - 140px);
      overflow:hidden;
    }

    .author-sidebar h3,
    .tags-sidebar h3{
      margin:0 0 10px 0;
      font-size:15px;
    }

    /* =========================================================
       Authors sidebar
       ========================================================= */
    .author-add { display:flex; gap:8px; margin-bottom:12px; }
    .author-add input {
      flex:1;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border-color);
      background:var(--bg-color);
      color:var(--text-color);
      font-size:13px;
    }

    .author-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      max-height: calc(100vh - 260px);
      padding-right: 6px;
    }

    .author-row{
      display:grid;
      grid-template-columns:1fr 34px;
      gap:8px;
      align-items:center;
    }

    .author-item{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid transparent;
      color:var(--text-color);
      background:rgba(255,255,255,0.03);
      text-decoration:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .author-item span:first-child{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .author-item.active{
      border-color: rgba(80,160,255,0.65);
      background: rgba(80,160,255,0.10);
    }

    .author-remove{
      width:34px;
      height:34px;
      border-radius:10px;
      border:1px solid var(--border-color);
      background:rgba(255,255,255,0.04);
      color:var(--text-color);
      cursor:pointer;
      font-size:18px;
      line-height:1;
    }
    .author-remove:hover{ border-color:var(--accent-color); }

    .author-new-badge{
      display:none;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      background:rgba(255,68,68,0.95);
      color:#fff;
      white-space:nowrap;
      flex-shrink:0;
    }

    /* =========================================================
       Tags sidebar: make columns behave like you asked
       - Tag col only as wide as needed (but capped)
       - # aligns with numbers
       ========================================================= */
    .tags-scroll{
      overflow:auto;
      max-height: calc(100vh - 180px);
      padding-right: 6px;
    }

    .tags-table{
      width:100%;
      border-collapse:collapse;
      table-layout:auto;
    }

    .tags-table thead th{
      font-size:12px;
      opacity:.75;
      font-weight:600;
      padding:8px 6px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      text-align:left;
      white-space:nowrap;
    }

    .tags-table td{
      padding:10px 6px;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      vertical-align:middle;
    }
    .tags-table tr:last-child td{ border-bottom:none; }

    /* Tag column: shrink-to-fit feel, but prevent absurd widths */
    .tag-col{
      width: 1%;
      white-space:nowrap;
      max-width: 210px;
    }
    .tag-col .tag-text{
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:210px;
    }

    /* # column right aligned and fixed-ish */
    .count-col{
      width: 70px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      opacity:.75;
    }

    /* action col compact */
    .action-col{
      width: 86px;
      text-align:right;
      white-space:nowrap;
    }

    .tag-filter-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--border-color);
      background:rgba(255,255,255,0.04);
      text-decoration:none;
      font-weight:900;
      line-height:1;
      margin-left:8px;
    }
    .tag-filter-btn:hover{
      background:rgba(255,255,255,0.08);
      border-color:var(--accent-color);
    }
    .tag-filter-btn.and{ color:#74ff74; }
    .tag-filter-btn.not{ color:#ff6b6b; }

    /* =========================================================
       Main: header + responsive “search row”
       ========================================================= */
    .author-main{
      background:var(--card-color);
      border:1px solid var(--border-color);
      border-radius:12px;
      box-shadow:0 2px 6px var(--shadow-2);
      padding:14px;
      min-height:360px;
      min-width:0;
    }

    .author-main-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }

    .author-titleblock h2{ margin:0; font-size:16px; }

    /* One row that can wrap: search+sort+apply | actions on the right of apply */
    /* Two-column header controls:
   left = search/sort/apply (fills),
   right = refresh/blur/mark seen (sticks right)
*/
    .controls-row{
      display:grid;
      grid-template-columns: 1fr max-content;
      gap: 10px;
      align-items:center;
      width:100%;
    }

    .author-search{
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;          /* important for flex children to shrink properly */
    }

    .author-search input[name="q"]{
      flex: 1 1 auto;
      min-width: 240px;
    }

    /* Right side stays tight and right-aligned */
    .right-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      white-space:nowrap;
    }


    /* chips */
    .chip-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0 6px; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border-color);
      background:rgba(255,255,255,0.04);
      font-size:12px;
      text-decoration:none;
      color:var(--text-color);
    }

    .chip.and{ border-color: rgba(116,255,116,0.35); }
    .chip.not{ border-color: rgba(255,107,107,0.35); }

    .chip a{
      text-decoration:none;
      color:var(--text-color);
      opacity:0.9;
      font-size:14px;
      line-height:1;
    }

    .meta-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:6px; }
    .meta-pill{
      font-size:12px; opacity:0.85; padding:4px 8px;
      border-radius:999px; border:1px solid var(--border-color);
      background:rgba(255,255,255,0.03);
    }

    .bot-new-badge{
      position:absolute;
      top:10px;
      right:10px;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      color:#fff;
      background:rgba(46, 204, 113, 0.95);
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }

    .bot-first-seen{
      font-size:12px;
      opacity:0.7;
      margin-top:6px;
    }

    /* =========================================================
       Bot grid: at least 3 across; scales with viewport/zoom
       ========================================================= */
    .bot-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
    }


    /* Responsive */
    @media (max-width: 1200px){
      .author-layout{ grid-template-columns: 1fr; }
      .author-sidebar, .tags-sidebar{
        position:static;
        max-height:none;
        overflow:visible;
      }
      .author-list, .tags-scroll{ max-height:none; }
      .author-search{ min-width: 0; flex: 1 1 100%; }
      .right-actions{ margin-left:0; width:100%; justify-content:flex-start; }
    }
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 24px;
    }
    .modal-card{
      width: min(920px, 100%);
      max-height: min(80vh, 900px);
      overflow: hidden;
      background: var(--card-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-color);
    }
    .modal-title{ font-weight: 700; }
    .modal-close{
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.04);
      color: var(--text-color);
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
    }
    .modal-meta{
      padding: 8px 14px;
      font-size: 12px;
      opacity: 0.8;
      border-bottom: 1px solid var(--border-color);
    }
    .modal-body{
      padding: 14px;
      overflow:auto;
      line-height: 1.45;
    }
    .modal-body pre{
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px;
      overflow:auto;
    }
    .modal-body code{
      background: rgba(255,255,255,0.05);
      padding: 1px 4px;
      border-radius: 6px;
    }
    
  </style>
</head>

<body class="authors-page">
  <div class="container">

    <header class="header">
      <div class="header-left">
        <h1>Author Tracker</h1>
      </div>

      <div class="header-right">
        <div class="stats">
          {% if last_snapshot %}
            <h3>Last Snapshot:
              <span class="stat-value">{{ last_snapshot }}</span>
            </h3>
          {% endif %}
        </div>
      
        <div class="header-actions" style="display:flex; gap:10px; align-items:center;">
          <a href="{{ url_for('index') }}" class="primary-button">← Dashboard</a>
          <a href="{{ url_for('global_trending') }}" class="primary-button">Global Trending</a>
        </div>
      </div>
    </header>

    <div class="author-layout">

      <!-- LEFT: AUTHORS -->
      <aside class="author-sidebar">
        <h3>Authors</h3>

        <form class="author-add" method="post" action="{{ url_for('authors_add') }}">
          <input name="author" placeholder="Add author username…" autocomplete="off" />
          <button class="primary-button" type="submit">+ Add</button>
        </form>

        <div class="author-list">
          <a class="author-item {% if selected_author == '__ALL__' %}active{% endif %}"
             href="{{ url_for('authors_page', author='__ALL__', q=q, and=and_raw, not=not_raw, sort=sort_field, order=order) }}">
            <span>All Tracked</span>
          </a>

          {% for a in authors %}
            <div class="author-row">
              <a class="author-item {% if selected_author == a %}active{% endif %}"
                 href="{{ url_for('authors_page', author=a, q=q, and=and_raw, not=not_raw, sort=sort_field, order=order) }}">
                <span>{{ a }}</span>
                <span class="author-new-badge" data-author="{{ a }}">0</span>
              </a>

              <form method="post" action="{{ url_for('authors_remove') }}">
                <input type="hidden" name="author" value="{{ a }}">
                <button type="submit" class="author-remove" title="Remove">×</button>
              </form>
            </div>
          {% endfor %}
        </div>
      </aside>

      <!-- CENTER: MAIN -->
      <main class="author-main">

        <div class="author-main-header">
          <div class="author-titleblock">
            <h2>{% if selected_author == '__ALL__' %}All Tracked{% else %}{{ selected_author }}{% endif %}</h2>
            <div class="subheader">Showing {{ bots|length }} bots</div>
          </div>

          <div class="controls-row">
            <!-- Search + Sort + Apply -->
            <form method="get" action="{{ url_for('authors_page') }}" class="author-search">
              <input type="hidden" name="author" value="{{ selected_author }}">
              <input type="hidden" name="and" value="{{ and_raw or '' }}">
              <input type="hidden" name="not" value="{{ not_raw or '' }}">

              <input name="q" value="{{ q or '' }}" placeholder="Search bots (name/title/tags/author)…" />

              <select name="sort">
                <option value="date" {% if sort_field == "date" %}selected{% endif %}>Date</option>
                <option value="name" {% if sort_field == "name" %}selected{% endif %}>Name</option>
              </select>

              <select name="order">
                <option value="desc" {% if order == "desc" %}selected{% endif %}>Desc</option>
                <option value="asc" {% if order == "asc" %}selected{% endif %}>Asc</option>
              </select>

              <button class="primary-button" type="submit">Apply</button>

              {% if q %}
                <a class="primary-button"
                   href="{{ url_for('authors_page', author=selected_author, and=and_raw, not=not_raw, sort=sort_field, order=order) }}">Clear</a>
              {% endif %}
            </form>

            <!-- Actions to the RIGHT of Apply -->
            <div class="right-actions">
              <form method="post" action="{{ url_for('authors_refresh') }}" style="display:inline;">
                <input type="hidden" name="author" value="{{ selected_author }}">
                <input type="hidden" name="q" value="{{ q or '' }}">
                <input type="hidden" name="and" value="{{ and_raw or '' }}">
                <input type="hidden" name="not" value="{{ not_raw or '' }}">
                <input type="hidden" name="sort" value="{{ sort_field }}">
                <input type="hidden" name="order" value="{{ order }}">
                <button class="primary-button" type="submit">Refresh Now</button>
                <button id="toggleBlurAuthors" type="button" class="btn-link">Toggle Blur</button>
              </form>

              <form method="post" action="{{ url_for('authors_mark_all_seen') }}" style="display:inline;">
                <input type="hidden" name="author" value="{{ selected_author }}">
                <input type="hidden" name="q" value="{{ q or '' }}">
                <input type="hidden" name="and" value="{{ and_raw or '' }}">
                <input type="hidden" name="not" value="{{ not_raw or '' }}">
                <input type="hidden" name="sort" value="{{ sort_field }}">
                <input type="hidden" name="order" value="{{ order }}">
                <button class="primary-button" type="submit">Mark all seen</button>
              </form>
            </div>
          </div>
        </div>

        {% if and_tags or not_tags %}
          <div class="chip-row">
            {% for t in and_tags %}
              {% set remaining_and = (and_tags | reject('equalto', t) | join(',')) %}
              <span class="chip and" title="Required tag">
                ✓ {{ t }}
                <a href="{{ url_for('authors_page',
                                    author=selected_author,
                                    q=q,
                                    and=remaining_and,
                                    not=not_raw,
                                    sort=sort_field,
                                    order=order) }}" title="Remove">×</a>
              </span>
            {% endfor %}

            {% for t in not_tags %}
              {% set remaining_not = (not_tags | reject('equalto', t) | join(',')) %}
              <span class="chip not" title="Excluded tag">
                ✕ {{ t }}
                <a href="{{ url_for('authors_page',
                                    author=selected_author,
                                    q=q,
                                    and=and_raw,
                                    not=remaining_not,
                                    sort=sort_field,
                                    order=order) }}" title="Remove">×</a>
              </span>
            {% endfor %}

            <a class="btn-link"
               href="{{ url_for('authors_page', author=selected_author, q=q, and='', not='', sort=sort_field, order=order) }}">Reset tags</a>
          </div>
        {% endif %}

        {% if not latest_stamp %}
          <p class="subheader">No snapshots yet—take a snapshot or click Refresh Now.</p>
        {% elif bots|length == 0 %}
          <p class="subheader">No bots match the current filters.</p>
        {% else %}
          <div class="bot-grid">
            {% for b in bots %}
              <div class="bot-card">
                {% if b.is_new %}
                  <div class="bot-new-badge" title="Created: {{ b.created_at }}">NEW</div>
                {% endif %}

                <a href="{{ url_for('go_bot', bot_id=b.bot_id) }}" target="_blank">
                  <img src="{{ b.avatar_url }}" alt="{{ b.name }} Avatar" class="bot-image">
                </a>

                <div class="bot-name">{{ b.name }}</div>
                <div class="bot-title">{{ b.title }}</div>
                {% if b.created_at %}
                  <div class="bot-first-seen">
                    Created: {{ b.created_at[:10] }}
                  </div>
                {% endif %}

                {% if b.author %}
                  <div class="meta-row">
                    <span class="meta-pill">{{ b.author }}</span>
                  </div>
                {% endif %}

                {% if b.tags %}
                  <div class="bot-tags">
                    {% for tag in b.tags %}
                      <a href="{{ url_for('authors_page',
                                          author=selected_author,
                                          q=q,
                                          and=((and_raw + ',' + tag) if and_raw else tag),
                                          not=not_raw,
                                          sort=sort_field,
                                          order=order) }}">
                        <span class="tag">{{ tag }}</span>
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
                <div style="margin-top:10px;">
                  <a href="#" class="btn-link view-greeting" data-bot-id="{{ b.bot_id }}">View Greeting</a>
                </div>                
              </div>
            {% endfor %}
          </div>
        {% endif %}

      </main>

      <!-- RIGHT: TAGS -->
      <aside class="tags-sidebar">
        <h3>Tags</h3>

        <div class="tags-scroll">
          <table class="tags-table">
            <tbody>
              {% for t in tags_list %}
                <tr>
                  <td class="tag-col"><span class="tag-text">{{ t.tag }}</span></td>
                  <td class="count-col">{{ t.count }}</td>
                  <td class="action-col">
                    <a class="tag-filter-btn and"
                       title="Require tag"
                       href="{{ url_for('authors_page',
                                        author=selected_author,
                                        q=q,
                                        and=((and_raw + ',' + t.tag) if and_raw else t.tag),
                                        not=not_raw,
                                        sort=sort_field,
                                        order=order) }}">✓</a>

                    <a class="tag-filter-btn not"
                       title="Exclude tag"
                       href="{{ url_for('authors_page',
                                        author=selected_author,
                                        q=q,
                                        and=and_raw,
                                        not=((not_raw + ',' + t.tag) if not_raw else t.tag),
                                        sort=sort_field,
                                        order=order) }}">✕</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </aside>

    </div>
  </div>

  <button id="scrollTopBtn" title="Back to top">↑</button>

  <!-- Greeting Modal -->
  <div id="greetingModal" class="modal-backdrop" style="display:none;">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="greetingTitle">
      <div class="modal-header">
        <div id="greetingTitle" class="modal-title">Greeting</div>
        <button id="greetingClose" class="modal-close" aria-label="Close">×</button>
      </div>
      <div id="greetingMeta" class="modal-meta"></div>
      <div id="greetingBody" class="modal-body"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("greetingModal");
      const closeBtn = document.getElementById("greetingClose");
      const bodyEl = document.getElementById("greetingBody");
      const metaEl = document.getElementById("greetingMeta");
  
      function openModal() { modal.style.display = "flex"; }
      function closeModal() { modal.style.display = "none"; bodyEl.innerHTML = ""; metaEl.textContent = ""; }
  
      closeBtn?.addEventListener("click", closeModal);
      modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });
  
      document.querySelectorAll(".view-greeting").forEach(a => {
        a.addEventListener("click", async (e) => {
          e.preventDefault();
          const botId = a.getAttribute("data-bot-id");
          if (!botId) return;
  
          metaEl.textContent = `Bot ID: ${botId}`;
          bodyEl.textContent = "Loading…";
          openModal();
  
          try {
            const res = await fetch(`/api/bot-greeting/${encodeURIComponent(botId)}`);
            const data = await res.json();
            const text = (data && data.greeting) ? String(data.greeting) : "";
  
            if (!text.trim()) {
              bodyEl.textContent = "(No greeting found.)";
              return;
            }
  
            // Render markdown safely-ish (marked does not sanitize by default)
            // If you want sanitization, we can add DOMPurify too.
            bodyEl.innerHTML = marked.parse(text);
          } catch (err) {
            bodyEl.textContent = "Failed to load greeting.";
          }
        });
      });
    });
  </script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("scrollTopBtn");
      if (!btn) return;

      window.addEventListener("scroll", () => {
        if (window.scrollY > 300) btn.classList.add("show");
        else btn.classList.remove("show");
      });

      btn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("toggleBlurAuthors");
      if (!btn) return;

      const KEY = "authors_blur";
      function applyBlur(on) {
        document.querySelectorAll(".bot-image").forEach(img => img.classList.toggle("blurred", on));
      }

      const saved = localStorage.getItem(KEY);
      if (saved === "true") applyBlur(true);

      btn.addEventListener("click", () => {
        const currentlyOn = document.querySelector(".bot-image.blurred") !== null;
        const next = !currentlyOn;
        applyBlur(next);
        localStorage.setItem(KEY, next ? "true" : "false");
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      async function refreshBadges() {
        document.querySelectorAll(".author-new-badge").forEach(b => {
          b.style.display = "none";
          b.textContent = "0";
        });

        const res = await fetch("/api/author-new-counts");
        const data = await res.json();
        const by = data.by_author || {};

        Object.keys(by).forEach(author => {
          const n = by[author] || 0;
          const el = document.querySelector(`.author-new-badge[data-author="${CSS.escape(author)}"]`);
          if (el && n > 0) {
            el.textContent = n;
            el.style.display = "inline-block";
          }
        });
      }

      try { await refreshBadges(); } catch (e) {}
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const err = {{ (add_error or "")|tojson }};
      const who = {{ (add_author or "")|tojson }};
      if (err) alert((who ? (who + ": ") : "") + err);
    });
  </script>

</body>
</html>
