{% if tags %}
  <div class="filter-chip-container">
    {% set active_tags = tags.split(',') %}
    {% for t in active_tags %}
      <span class="filter-chip">
        {{ t }}
        {% set remaining = (active_tags | reject('equalto', t) | join(',')) %}
        <a class="filter-chip-x"
           href="{{ url_for('index',
                            sort_by=sort_by,
                            sort_asc=('true' if sort_asc else 'false'),
                            created_after=created_after,
                            chart_sort_by=chart_sort_by,
                            chart_sort_asc=('true' if chart_sort_asc else 'false'),
                            timeframe=timeframe,
                            tags=remaining,
                            q=q) }}">Ã—</a>
      </span>
    {% endfor %}

    <a class="btn-link"
       href="{{ url_for('index',
                        sort_by=sort_by,
                        sort_asc=('true' if sort_asc else 'false'),
                        created_after=created_after,
                        chart_sort_by=chart_sort_by,
                        chart_sort_asc=('true' if chart_sort_asc else 'false'),
                        timeframe=timeframe,
                        tags='',
                        q=q) }}">Reset tags</a>
  </div>
{% endif %}

<div class="bot-grid">
    {% for bot in bots %}
    <div class="bot-card">
        {% if bot.rank and bot.rank_tier %}
        <div class="bot-ranking {{ bot.rank_tier }}">
            #{{ bot.rank }}
        </div>
        {% endif %}

        <a href="{{ bot.link }}" target="_blank">
            <img src="{{ bot.avatar_url }}" alt="{{ bot.name }} Avatar" class="bot-image">
        </a>
        <div class="bot-name">{{ bot.name }}</div>
        <div class="bot-title">{{ bot.title }}</div>
        {% if bot.tags %}
        <div class="bot-tags">
            {% set active = (tags or '').split(',') if tags else [] %}
            {% for tag in bot.tags %}
            {% set next_tags = (active + [tag]) | unique | join(',') %}
            <a href="{{ url_for('index',
                                sort_by=sort_by,
                                sort_asc=('true' if sort_asc else 'false'),
                                created_after=created_after,
                                chart_sort_by=chart_sort_by,
                                chart_sort_asc=('true' if chart_sort_asc else 'false'),
                                timeframe=timeframe,
                                tags=next_tags,
                                q=q) }}">
                <span class="tag">{{ tag }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}
        <div class="bot-stats">Total: {{ bot.total_fmt }}</div>
        <div class="bot-stats">Delta: {{ bot.delta_fmt }}</div>
        {% if bot.rating_pct is not none %}
        <div class="bot-stats">Rating: {{ "%.0f"|format(bot.rating_pct) }}%</div>
        {% endif %}
      
        <div class="bot-stats">Created: {{ bot.created_at }}</div>
        <div class="bot-actions">
            <a href="{{ url_for('bot_detail', bot_id=bot.bot_id) }}"
               class="details-link">
                Details
            </a>
        
            <a href="https://spicychat.ai/chatbot/edit/{{ bot.bot_id }}"
               target="_blank"
               class="details-link">
                Edit
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    .bot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .bot-card {
        position: relative; /* NEW: for rank badge */
        background-color: #2a2a2a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
    }
    .bot-card:hover {
        transform: scale(1.05);
    }
    .bot-image {
        width: 100%;
        height: auto;
        border-radius: 4px;
        cursor: pointer;
        transition: filter 0.3s;
    }
    .bot-image.blurred {
        filter: blur(10px);
    }
    .bot-name {
        font-size: 16px;
        margin: 10px 0 5px;
        color: #ffffff;
    }
    .bot-title {
        font-size: 14px;
        color: #b0b0b0;
        margin-bottom: 10px;
    }

    .bot-stats {
        font-size: 14px;
        color: #e0e0e0;
    }
    .details-link {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #3c6e9f;
        color: #ffffff;
        text-decoration: none;
        border-radius: 4px;
    }
    .details-link:hover {
        background-color: #355e8a;
    }

    /* NEW: rank tag styles */
    .bot-ranking {
        position: absolute;
        top: 8px;
        left: 8px;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        color: #ffffff;
        background-color: rgba(0, 0, 0, 0.7); /* fallback */
    }
    .bot-ranking.top240 {
        background-color: #b22222; /* red */
    }
    .bot-ranking.top480 {
        background-color: #ff8c00; /* orange */
    }
</style>
