<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpicyChat Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>SpicyChat Analytics</h1>
            <div class="stats">
                Total Messages: <span class="stat-value">{{ total_messages }}</span> | 
                Total Bots: <span class="stat-value">{{ total_bots }}</span> (as of {{ latest }})
            </div>
            <form action="/take-snapshot" method="post" class="action-form">
                <button type="submit" class="action-button">Take Snapshot</button>
            </form>
            <div class="chart-controls">
                <form method="get" action="/">
                    <select name="chart_sort_by" onchange="this.form.submit()" style="padding: 5px; border: 1px solid #444; border-radius: 4px; background-color: #333; color: #e0e0e0;">
                        <option value="7day" {% if chart_sort_by == '7day' %}selected{% endif %}>7 Days</option>
                        <option value="30day" {% if chart_sort_by == '30day' %}selected{% endif %}>30 Days</option>
                        <option value="current_month" {% if chart_sort_by == 'current_month' %}selected{% endif %}>Current Month</option>
                        <option value="All" {% if chart_sort_by == 'All' %}selected{% endif %}>All</option>
                    </select>
                    <input type="hidden" name="sort_by" value="{{ sort_by }}">
                    <input type="hidden" name="sort_asc" value="{{ sort_asc }}">
                    <input type="hidden" name="timeframe" value="{{ chart_sort_by }}">
                    <input type="hidden" name="created_after" value="{{ created_after }}">
                </form>
            </div>
        </header>
        <div class="chart-container">
            <img src="{{ url_for('static', filename='charts/total_messages_' + chart_sort_by.replace(' ', '_') + '.png') }}" alt="Total Messages Chart" class="chart">
            <img src="{{ url_for('static', filename='charts/total_daily_changes_' + chart_sort_by.replace(' ', '_') + '.png') }}" alt="Total Daily Message Changes Chart" class="chart">
        </div>
        <div class="totals-section">
            <button id="toggleTotals" class="toggle-button">Hide Totals</button>
            <table id="totalsTable" class="totals-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Total Messages</th>
                        <th>Total Daily Message Changes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for total in totals %}
                    <tr>
                        <td>{{ total.date }}</td>
                        <td>{{ total.total_fmt }}</td>
                        <td>{{ total.daily_fmt }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="bot-controls">
            <form method="get" action="/">
                <div class="left-controls" style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 16px; color: #3c6e9f; margin: 0; padding: 5px 10px; background-color: #2a2a2a; border-radius: 4px;">Sort by:</label>
                    <select name="sort_by" onchange="this.form.submit()" style="padding: 5px; border: 1px solid #444; border-radius: 4px; background-color: #333; color: #e0e0e0;">
                        <option value="delta" {% if sort_by == 'delta' %}selected{% endif %}>Delta</option>
                        <option value="total" {% if sort_by == 'total' %}selected{% endif %}>Total</option>
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Created At</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                    </select>
                    <select name="sort_asc" onchange="this.form.submit()" style="padding: 5px; border: 1px solid #444; border-radius: 4px; background-color: #333; color: #e0e0e0;">
                        <option value="false" {% if not sort_asc %}selected{% endif %}>Descending</option>
                        <option value="true" {% if sort_asc %}selected{% endif %}>Ascending</option>
                    </select>
                </div>
                <div class="right-controls" style="display: flex; align-items: center; justify-content: flex-end; gap: 10px; flex-grow: 1;">
                    <label style="font-size: 16px; color: #3c6e9f; margin: 0; padding: 5px 10px; background-color: #2a2a2a; border-radius: 4px;">Created in:</label>
                    <select name="created_after" onchange="this.form.submit()" style="padding: 5px; border: 1px solid #444; border-radius: 4px; background-color: #333; color: #e0e0e0;">
                        <option value="All" {% if created_after == 'All' %}selected{% endif %}>All</option>
                        <option value="7day" {% if created_after == '7day' %}selected{% endif %}>7 Days</option>
                        <option value="30day" {% if created_after == '30day' %}selected{% endif %}>30 Days</option>
                        <option value="current_month" {% if created_after == 'current_month' %}selected{% endif %}>Current Month</option>
                    </select>
                </div>
                <input type="hidden" name="chart_sort_by" value="{{ chart_sort_by }}">
                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                <input type="hidden" name="sort_asc" value="{{ sort_asc }}">
                <input type="hidden" name="timeframe" value="{{ timeframe }}">
            </form>
            <button id="toggleBlur" class="toggle-button">Blur Avatars</button>
        </div>
        <div id="botTableContainer">
            {% include 'bots_table.html' %}
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleTotals = document.getElementById('toggleTotals');
            const totalsTable = document.getElementById('totalsTable');
            let isTotalsCollapsed = sessionStorage.getItem('totalsCollapsed') === 'true';
            totalsTable.style.display = isTotalsCollapsed ? 'none' : 'table';
            toggleTotals.textContent = isTotalsCollapsed ? 'Show Totals' : 'Hide Totals';
            toggleTotals.addEventListener('click', () => {
                isTotalsCollapsed = !isTotalsCollapsed;
                totalsTable.style.display = isTotalsCollapsed ? 'none' : 'table';
                toggleTotals.textContent = isTotalsCollapsed ? 'Show Totals' : 'Hide Totals';
                sessionStorage.setItem('totalsCollapsed', isTotalsCollapsed);
            });

            const toggleBlur = document.getElementById('toggleBlur');
            let isBlurred = sessionStorage.getItem('avatarsBlurred') === 'true';
            const botImages = document.querySelectorAll('.bot-image');
            botImages.forEach(img => img.classList.toggle('blurred', isBlurred));
            toggleBlur.textContent = isBlurred ? 'Unblur Avatars' : 'Blur Avatars';
            toggleBlur.addEventListener('click', () => {
                isBlurred = !isBlurred;
                botImages.forEach(img => img.classList.toggle('blurred', isBlurred));
                toggleBlur.textContent = isBlurred ? 'Unblur Avatars' : 'Blur Avatars';
                sessionStorage.setItem('avatarsBlurred', isBlurred);
            });
        });
    </script>
</body>
</html>