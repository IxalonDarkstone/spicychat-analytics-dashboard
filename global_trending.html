<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Global Trending — Top 480 Bots</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        /* Page-scoped container */
        .global-wrapper .global-container {
            max-width: none;
            width: 95%;
            margin: 32px auto;
        }

        /* Two-column responsive layout */
        .layout-container {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 280px;
            gap: 32px;
            align-items: start;
        }

        @media (max-width: 1400px) {
            .layout-container {
                grid-template-columns: 1fr;
            }
        }

        .right-column {
            position: sticky;
            top: 110px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .sidebar-box {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 6px var(--shadow-2);
        }

        .sidebar-box h3 {
            text-align: center;
            margin-bottom: 12px;
        }

        .sidebar-table td, .sidebar-table th {
            padding: 6px 4px;
            font-size: 13px;
        }

        .creator-filter-link {
            color: var(--accent-color);
        }
    </style>
</head>

<body>

<div class="global-wrapper">
    <div class="container global-container">

        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>Global Trending</h1>
                <div class="subheader">Top 480 Bots (Snapshot)</div>
            </div>

            <div class="header-right">
                <a href="/" class="primary-button">Back to Dashboard</a>
            </div>
        </header>

        <!-- Sorting Controls -->
        <form method="get" class="bot-filter-form"
              style="margin-bottom:20px; display:flex; gap:20px;">

            <label>
                Sort by:
                <select name="sort">
                    <option value="rank" {% if sort_field == "rank" %}selected{% endif %}>Rank</option>
                    <option value="messages" {% if sort_field == "messages" %}selected{% endif %}>Messages</option>
                    <option value="author" {% if sort_field == "author" %}selected{% endif %}>Author</option>
                </select>
            </label>

            <label>
                Order:
                <select name="order">
                    <option value="asc" {% if order == "asc" %}selected{% endif %}>Ascending</option>
                    <option value="desc" {% if order == "desc" %}selected{% endif %}>Descending</option>
                </select>
            </label>

            {% if author_filter %}
            <input type="hidden" name="author" value="{{ author_filter }}">
            {% endif %}

            <button class="primary-button" type="submit">Apply</button>
        </form>

        <button id="toggleBlur" class="btn-link" style="margin-bottom:15px;">Toggle Blur</button>

        <!-- Filter indicator -->
        {% if author_filter %}
            <div style="margin-bottom:15px;">
                <a href="/global-trending" class="primary-button" style="margin-right:10px;">
                    Reset Filter
                </a>
                <span style="color:var(--text-muted);">
                    Showing bots by <strong>{{ author_filter }}</strong>
                </span>
            </div>
        {% endif %}

        <!-- LAYOUT: GRID + SIDEBAR -->
        <div class="layout-container">

            <!-- LEFT COLUMN: BOT CARDS -->
            <div class="left-column">
                <div class="bot-grid">
                    {% for b in bots %}
                    <div class="bot-card">

                        <div class="bot-ranking {% if b.rank <= 240 %}top240{% else %}top480{% endif %}">
                            #{{ b.rank }}
                        </div>

                        <a href="{{ b.link }}" target="_blank">
                            <img class="bot-image" src="{{ b.avatar_url }}" alt="{{ b.name }}">
                        </a>

                        <div class="bot-name">{{ b.name }}</div>
                        <div class="bot-title">{{ b.title }}</div>

                        <div class="bot-stats">Total: {{ b.num_messages }}</div>

                        <div class="bot-stats">
                            Author:
                            <!-- CARD AUTHOR → CREATOR PAGE (NOT FILTER) -->
                            <a href="https://spicychat.ai/creator/{{ b.creator_username }}"
                               target="_blank">
                                {{ b.creator_username }}
                            </a>
                        </div>

                        <a href="{{ b.link }}" target="_blank" class="details-link">Chat</a>

                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- RIGHT COLUMN: LEADERBOARD FILTER -->
            <div class="right-column">
                <div class="sidebar-box">

                    <h3>Top Creators</h3>

                    <table class="sidebar-table">
                        <thead>
                            <tr>
                                <th>Creator</th>
                                <th>#</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for c in creators %}
                            <tr>
                                <td>
                                    <!-- SIDEBAR AUTHOR → FILTER -->
                                    <a href="?author={{ c.creator }}&sort={{ sort_field }}&order={{ order }}"
                                       class="creator-filter-link">
                                       {{ c.creator }}
                                    </a>
                                </td>
                                <td>{{ c.count }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </div>
            </div>

        </div> <!-- end layout-container -->

        <!-- Pagination -->
        <div style="margin:30px 0; display:flex; justify-content:center; gap:10px;">
            {% if page > 1 %}
                <a class="primary-button"
                   href="?page={{ page-1 }}{% if author_filter %}&author={{ author_filter }}{% endif %}&sort={{ sort_field }}&order={{ order }}">
                    Prev
                </a>
            {% endif %}

            <span style="padding:10px; opacity:0.7;">
                Page {{ page }} / {{ total_pages }}
            </span>

            {% if page < total_pages %}
                <a class="primary-button"
                   href="?page={{ page+1 }}{% if author_filter %}&author={{ author_filter }}{% endif %}&sort={{ sort_field }}&order={{ order }}">
                    Next
                </a>
            {% endif %}
        </div>

    </div> <!-- end global-container -->
</div> <!-- end global-wrapper -->

<script>
document.getElementById("toggleBlur")
    .addEventListener("click", () => {
        document.querySelectorAll(".bot-image")
            .forEach(img => img.classList.toggle("blurred"));
    });
</script>

</body>
</html>
